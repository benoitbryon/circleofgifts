#!/bin/sh
# Bootstraps marmelune.net project environment for deployment:
#
# * zc.buildout:
# 
#   * bootstrap buildout
#   * run buildout with bootstrap configuration file
#   * buildout directories are stored in lib/buildout
#
# On success, creates a var/bootstapped file. This file is used as a flag to
# avoid bootstrapping twice.
#


###############################################################################
# Initializations


# Detect path
BINPATH="$( cd "$( dirname "$0" )" && pwd )";
ROOTPATH="`dirname "$BINPATH"`";

# Bootstrap flag
bootstrap_flag_file=$ROOTPATH/var/bootstrapped

# Buildout
buildout_bootstrap_script="$ROOTPATH/src/bootstrap/bootstrap.py"
buildout_bootstrap_conf="$ROOTPATH/src/etc/buildout/bootstrap.cfg"


###############################################################################
# Functions


# Locate Python executable.
# Assign global $python variable.
which_python()
{
    # Try system's global Python
    python=`which python`
    if [ ! -x $python ]; then
        echo "Couldn't autodetect Python. Make sure Python is installed."
		exit 1
    else
        echo "Using $python, which version is:"
        $python --version
    fi
}


# Bootstrap buildout
bootstrap_buildout()
{
    $python $buildout_bootstrap_script --distribute -c $buildout_bootstrap_conf buildout:directory=$ROOTPATH
}


# Run buildout
run_buildout()
{
    $ROOTPATH/bin/buildout -N -c $buildout_bootstrap_conf buildout:directory=$ROOTPATH
}


# Actually perform bootstrap.
bootstrap()
{
    # Make sure not to bootstrap twice!
    if [ -e  $bootstrap_flag_file ]; then
        echo "ERROR: project seems to have already been bootstrapped! $bootstrap_flag_file already exists. Cannot bootstrap again."
        exit 1
    fi

    # Locate Python
    which_python

    # Bootstrap buildout
    echo "Bootstraping zc.buildout..."
    success=0
    mkdir -p $ROOTPATH/lib/buildout
    bootstrap_buildout && run_buildout && success=1
    if [ ! $success -eq 1 ]; then
        echo "ERROR: buildout returned an error. See messages above."
        exit 1
    else
        echo "Done. zc.buildout bootstrapped."
        echo "You may use 'bin/paster' to configure your deployment. Try 'bin/paster create --list-templates' to see available templates."
    fi

    # Bootstrap flag
    mkdir -p `dirname $bootstrap_flag_file`
    touch $bootstrap_flag_file
}


###############################################################################
# Main


bootstrap
